# Template file for 'libgeonames'
pkgname=libgeonames
version=0.2.0r97
revision=1
# TODO: track main branch after merge of ubports/core/geonames!1
_commit=334522ebf59b84e65f59aa3bccdb9f00efeee7ae # tip of personal/mariogrip/alt-split branch as of 2022-05-25
wrksrc="geonames-${_commit}"
build_style=cmake
configure_args="$(vopt_bool demo WANT_DEMO) $(vopt_bool doc WANT_DOC)"
hostmakedepends="pkg-config gettext $(vopt_if doc gtk-doc)"
makedepends="glib-devel $(vopt_if demo gtk+3-devel)"
short_desc="Library to parse and query the geonames database dump (personal/mariogrip/alt-split branch)"
maintainer="Jami Kettunen <jami.kettunen@protonmail.com>"
license="GPL-3.0-only, CC-BY-3.0"
homepage="https://launchpad.net/geonames"
distfiles="https://gitlab.com/ubports/core/geonames/-/archive/${_commit}.tar.gz"
checksum=3603d92052e3a68e6d8216fc59a576a87ca8aad885a581d8a779a944bff10309

build_options="demo doc"
desc_option_demo="Build gtk+3 demo"
desc_option_doc="Build gtk-doc"
build_options_default="demo"

if [ -z "$XBPS_CHECK_PKGS" ] || [ "$CROSS_BUILD" ]; then
	configure_args+=" -DWANT_TESTS=OFF"
fi

# FIXME: cross build broken due to compile of host tool (mkdb) build for target
# https://gitlab.com/ubports/core/geonames/-/merge_requests/1#note_881210952
build_helper="qemu"

# FIXME: Error processing file: GTKDOC_SCANGOBJ_WRAPPER-NOTFOUND during geonames.signals generation
# https://gitlab.com/ubports/core/geonames/-/merge_requests/1#note_881266376
if [ "${build_option_doc}" ] && [ "$CROSS_BUILD" ]; then
	makedepends+=" gtk-doc"
fi

pre_build() {
	if [ "${build_option_doc}" ]; then
		# FIXME: ld: unrecognized option '-Wl,-z,relro' during geonames.signals generation with gtkdoc-scangobj
		# https://gitlab.com/ubports/core/geonames/-/merge_requests/1#note_881266762
		LD="${CC}"
	fi
}

libgeonames-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/pkgconfig
		if [ "$build_option_doc" ]; then
			vmove usr/share/gtk-doc
		fi
		vmove "usr/lib/*.so"
	}
}
