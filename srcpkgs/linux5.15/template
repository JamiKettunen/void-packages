# Template file for 'linux5.15'
pkgname=linux5.15
version=5.15.14
revision=1
build_style=linux-kernel
wrksrc="linux-${version%.*}"
short_desc="Linux kernel and modules (${version%.*} series)"
maintainer="Leah Neukirchen <leah@vuxu.org>"
license="GPL-2.0-only"
homepage="https://www.kernel.org"
distfiles="
	https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-${version%.*}.tar.xz
	https://cdn.kernel.org/pub/linux/kernel/v5.x/patch-${version}.xz
"
checksum="
	57b2cf6991910e3b67a1b3490022e8a0674b6965c74c12da1e99d138d1991ee8
	283bf58378a8f8ff457fc1259dd2864dc4de92295482ef3ae868e13e017250ee
"
skip_extraction="patch-${version}.xz"

# XXX Restrict archs until a proper <arch>-dotconfig is available in FILESDIR.
archs="x86_64* i686* aarch64* ppc*"

preserve=yes

hostmakedepends="flex python3 elfutils-devel openssl-devel bc perl tar xz cpio
 pahole kmod"

triggers="kernel-hooks"
# FIXME: _kernver not available here???
kernel_hooks_version="${_kernver}"

pre_patch() {
	xzcat $XBPS_SRCDISTDIR/$pkgname-$version/patch-${version}.xz | patch -Np1
}

linux5.15-headers_package() {
	preserve=yes
	nostrip=yes
	noshlibprovides=yes
	short_desc+=" - source headers for 3rd party modules"
	pkg_install() {
		vmove usr/src
		vmove usr/lib/modules/${_kernver}/build
	}
}
linux5.15-dbg_package() {
	preserve=yes
	nostrip=yes
	noverifyrdeps=yes
	noshlibprovides=yes
	repository=debug
	short_desc+=" - debugging symbols"
	pkg_install() {
		vmove usr/lib/debug
		vmove "boot/System.map-${_kernver}"
	}
}
